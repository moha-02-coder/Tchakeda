<div class="page-container">
  <div class="page-header">
    <button class="btn btn-light back-btn" (click)="back()">
      <i class="fas fa-arrow-left"></i> Bâtiments
    </button>
    <h4 class="page-title">Détail du bâtiment</h4>
  </div>

  <!-- Modal de suppression -->
  <div *ngIf="showDeleteConfirm" class="modal-overlay">
    <div class="modal-card">
      <h5>Confirmer la suppression</h5>
      <p>Voulez-vous vraiment supprimer ce bâtiment ? Cette action est irréversible.</p>
      <div class="form-actions center">
        <button type="button" class="btn btn-light" (click)="showDeleteConfirm = false">Annuler</button>
        <button type="button" class="btn btn-danger" (click)="deleteBuilding()">Supprimer</button>
      </div>
    </div>
  </div>

  <div class="form-card">
    <!-- En-tête avec actions -->
    <div class="card-header">
      <h5>Informations du bâtiment</h5>
      <div class="action-buttons" *ngIf="!editMode">
        <button class="action-btn edit" (click)="enableEdit()" title="Modifier">
          <i class="fas fa-edit"></i>
        </button>
        <button class="action-btn delete" title="Supprimer le bâtiment" (click)="showDeleteConfirm = true">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div class="action-buttons" *ngIf="editMode">
        <button class="action-btn save" type="submit" form="buildingForm" title="Enregistrer">
          <i class="fas fa-check"></i>
        </button>
        <button class="action-btn cancel" (click)="cancelEdit()" title="Annuler">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Mode édition -->
    <form *ngIf="editMode" (ngSubmit)="save()" id="buildingForm" class="building-form">
      <div class="form-grid">
        <!-- Image du bâtiment -->
        <div class="form-group full-width">
          <label>Image du bâtiment</label>
          <div class="building-image-container">
            <div class="image-wrapper">
              <div class="image-container">
                <img [src]="form.image || 'assets/images/default-building.jpg'" alt="Bâtiment" class="building-img" />
                <div class="image-overlay">
                  <i class="fas fa-camera"></i>
                  <span>Changer l'image</span>
                </div>
              </div>
              <input type="file" id="buildingImageUpload" (change)="onBuildingImageSelected($event)" class="file-input" accept="image/*" />
              <label for="buildingImageUpload" class="file-input-label">Parcourir</label>
            </div>
          </div>
        </div>

        <!-- Nom du bâtiment -->
        <div class="form-group">
          <input type="text" id="name" [(ngModel)]="form.name" name="name" class="underline-input" required placeholder="Nom du bâtiment" />
          <label for="name" class="label">Nom du bâtiment</label>
          <div class="error" *ngIf="errors.name">{{ errors.name }}</div>
        </div>

        <!-- Type de bâtiment -->
        <div class="form-group">
          <div class="input-with-button">
            <select id="type" [(ngModel)]="form.type" name="type" class="underline-input" required (change)="onTypeChange($event)">
              <option [ngValue]="null">Sélectionner...</option>
              <option value="résidentiel">Résidentiel</option>
              <option value="commercial">Commercial</option>
              <option value="mixte">Mixte</option>
              <option value="autre">Autre...</option>
            </select>
            <!-- label for select -->
            <label for="type" class="label">Type de bâtiment</label>
          </div>
          <input *ngIf="isCustomType" type="text" id="customType" [(ngModel)]="form.customType" name="customType" class="underline-input custom-type-input" placeholder="Saisir le type" />
          <div class="error" *ngIf="errors.type">{{ errors.type }}</div>
          <div class="error" *ngIf="errors.customType">{{ errors.customType }}</div>
        </div>

        <!-- Nombre d'étages -->
        <div class="form-group">
          <input type="number" id="floors" [(ngModel)]="form.floors" name="floors" class="underline-input" required min="1" placeholder="Nombre d'étages" />
          <label for="floors" class="label">Nombre d'étages</label>
          <div class="error" *ngIf="errors.floors">{{ errors.floors }}</div>
        </div>

        <!-- Nombre d'appartements -->
        <div class="form-group">
          <input type="number" id="apartments" [(ngModel)]="form.apartments" name="apartments" class="underline-input" required min="1" placeholder="Nombre d'appartements" />
          <label for="apartments" class="label">Nombre d'appartements</label>
          <div class="error" *ngIf="errors.apartments">{{ errors.apartments }}</div>
        </div>

        <!-- Adresse -->
        <div class="form-group">
          <input type="text" id="address" [(ngModel)]="form.address" name="address" class="underline-input" required placeholder="Adresse" />
          <label for="address" class="label">Adresse</label>
          <div class="error" *ngIf="errors.address">{{ errors.address }}</div>
        </div>

        <!-- Ville -->
        <div class="form-group">
          <input type="text" id="city" [(ngModel)]="form.city" name="city" class="underline-input" required placeholder="Ville" />
          <label for="city" class="label">Ville</label>
          <div class="error" *ngIf="errors.city">{{ errors.city }}</div>
        </div>

        <!-- Quartier / Région -->
        <div class="form-group">
          <input type="text" id="region" [(ngModel)]="form.region" name="region" class="underline-input" required placeholder="Quartier / Région" />
          <label for="region" class="label">Quartier / Région</label>
          <div class="error" *ngIf="errors.region">{{ errors.region }}</div>
        </div>

        <!-- Date de construction -->
        <div class="form-group">
          <input type="date" id="constructionDate" [(ngModel)]="form.constructionDate" name="constructionDate" class="underline-input" required placeholder="Date de construction" />
          <label for="constructionDate" class="label">Date de construction</label>
          <div class="error" *ngIf="errors.constructionDate">{{ errors.constructionDate }}</div>
        </div>

        <!-- Propriétaire -->
        <div class="form-group">
          <div class="select-with-action">
            <select id="ownerId" [(ngModel)]="form.ownerId" name="ownerId" class="underline-input" required>
              <option [ngValue]="null">Sélectionner un propriétaire...</option>
              <option *ngFor="let owner of owners" [ngValue]="owner.id">{{ owner.name }}</option>
            </select>
            <label for="ownerId" class="label">Propriétaire</label>
            <button type="button" class="btn btn-link" (click)="goToNewOwner()" title="Ajouter un propriétaire">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="error" *ngIf="errors.ownerId">{{ errors.ownerId }}</div>
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions full-width">
        <button type="button" class="btn btn-light" (click)="cancelEdit()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>

    <!-- Mode visualisation -->
    <div *ngIf="!editMode" class="view-mode">
      <!-- Image du bâtiment -->
      <div class="building-image-container full-width">
        <div class="image-wrapper">
          <div class="image-container">
            <img [src]="building?.image || 'assets/images/default-building.jpg'" alt="Bâtiment" class="building-img" />
          </div>
        </div>
        <div *ngIf="!building?.image" class="no-image">
          <i class="fas fa-building"></i>
          <p>Aucune photo disponible</p>
        </div>
      </div>

      <!-- Infos en grille -->
      <div class="details-grid">
        <div class="form-group">
          <input id="view-name" class="underline-input" [value]="building?.name || '-'" readonly />
          <label for="view-name" class="label">Nom du bâtiment</label>
        </div>
        <div class="form-group">
          <input id="view-type" class="underline-input" [value]="building?.type === 'autre' ? (building?.customType || '-') : building?.type || '-'" readonly />
          <label for="view-type" class="label">Type de bâtiment</label>
        </div>
        <div class="form-group">
          <input id="view-floors" class="underline-input" [value]="building?.floors || '-'" readonly />
          <label for="view-floors" class="label">Nombre d'étages</label>
        </div>
        <div class="form-group">
          <input id="view-apartments" class="underline-input" [value]="building?.apartments || '-'" readonly />
          <label for="view-apartments" class="label">Nombre d'appartements</label>
        </div>
        <div class="form-group">
          <input id="view-address" class="underline-input" [value]="building?.address || '-'" readonly />
          <label for="view-address" class="label">Adresse</label>
        </div>
        <div class="form-group">
          <input id="view-city" class="underline-input" [value]="building?.city || '-'" readonly />
          <label for="view-city" class="label">Ville</label>
        </div>
        <div class="form-group">
          <input id="view-region" class="underline-input" [value]="building?.region || '-'" readonly />
          <label for="view-region" class="label">Quartier / Région</label>
        </div>
        <div class="form-group">
          <input id="view-constructionDate" class="underline-input" [value]="building && building.constructionDate ? (building.constructionDate | date:'dd/MM/yyyy') : '-'" readonly />
          <label for="view-constructionDate" class="label">Date de construction</label>
        </div>
        <div class="form-group">
          <input id="view-ownerId" class="underline-input" [value]="getOwnerName(building?.ownerId) || '-'" readonly />
          <label for="view-ownerId" class="label">Propriétaire</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Section appartements du bâtiment -->
  <div class="form-card" *ngIf="!editMode && buildingApartments.length > 0">
    <div class="card-header">
      <h5>Appartements du bâtiment</h5>
    </div>
    
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Type</th>
            <th>Pièces</th>
            <th>Locataire</th>
            <th>Mensualité</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let apartment of buildingApartments" (click)="goToApartment(apartment.id)" class="clickable-row">
            <td>{{ apartment.name || '-' }}</td>
            <td>{{ apartment.type || '-' }}</td>
            <td>{{ apartment.rooms || '-' }}</td>
            <td>{{ apartment.tenant || 'Libre' }}</td>
            <td>{{ apartment.mention ? (apartment.mention | number) + ' FCFA' : '-' }}</td>
            <td>
              <span class="status-badge" [ngClass]="{
                'status-occupied': apartment.tenant,
                'status-free': !apartment.tenant
              }">
                {{ apartment.tenant ? 'Occupé' : 'Libre' }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Section statistiques -->
  <div class="form-card" *ngIf="!editMode">
    <div class="card-header">
      <h5>Statistiques du bâtiment</h5>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ buildingApartments.length }}</div>
        <div class="stat-label">Appartements total</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-value">{{ occupiedApartmentsCount }}</div>
        <div class="stat-label">Appartements occupés</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-value">{{ freeApartmentsCount }}</div>
        <div class="stat-label">Appartements libres</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-value">{{ occupancyRate }}%</div>
        <div class="stat-label">Taux d'occupation</div>
      </div>
    </div>
  </div>
</div>