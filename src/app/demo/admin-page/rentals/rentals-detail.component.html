<div class="page-container">
  <div class="page-header d-flex align-items-center justify-content-between">
    <button class="btn btn-light back-btn" (click)="back()">
      <i class="fas fa-arrow-left"></i> Locations
    </button>
    <h4 class="page-title">Détails de la location</h4>
  </div>

  <!-- ✅ Modal de suppression -->
  <div *ngIf="showDeleteConfirm" class="modal-overlay">
    <div class="modal-card">
      <h5>Confirmer la suppression</h5>
      <p>Voulez-vous vraiment supprimer cette location ? Cette action est irréversible.</p>
      <div class="form-actions center">
        <button type="button" class="btn btn-light" (click)="showDeleteConfirm = false">Annuler</button>
        <button type="button" class="btn btn-danger" (click)="deleteRental()">Supprimer</button>
      </div>
    </div>
  </div>

  <div class="content-container">
    <!-- ✅ Mode édition -->
    <form *ngIf="editMode" (ngSubmit)="save()" class="form-card">
      <div class="card-header">
        <h5>Informations de la location</h5>
        <div class="action-buttons">
          <button class="action-btn save" type="submit" title="Enregistrer les modifications">
            <i class="fas fa-check"></i>
          </button>
        </div>
      </div>
      <div class="form-grid">
        <!-- Appartement -->
        <div class="form-group">
          <label>Appartement</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <select [(ngModel)]="form.apartmentId" name="apartmentId" class="underline-input" required>
              <option [ngValue]="null">Sélectionner...</option>
              <option *ngFor="let apt of apartments" [ngValue]="apt.id">{{ apt.name }}</option>
            </select>
            <button type="button" class="btn btn-link" (click)="goToNewApartment()" title="Ajouter un appartement">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="error" *ngIf="errors.apartmentId">{{ errors.apartmentId }}</div>
        </div>

        <!-- Locataire -->
        <div class="form-group">
          <label>Locataire</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <select [(ngModel)]="form.tenantId" name="tenantId" class="underline-input" required>
              <option [ngValue]="null">Sélectionner...</option>
              <option *ngFor="let t of tenants" [ngValue]="t.id">{{ t.fullName }}</option>
            </select>
            <button type="button" class="btn btn-link" (click)="goToNewTenant()" title="Ajouter un locataire">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="error" *ngIf="errors.tenantId">{{ errors.tenantId }}</div>
  <!-- Suppression des modals ajout appartement/locataire, navigation à la place -->
        </div>

        <!-- Date début -->
        <div class="form-group">
          <label>Date début</label>
          <input type="date" [(ngModel)]="form.startDate" name="startDate" class="underline-input" required />
          <div class="error" *ngIf="errors.startDate">{{ errors.startDate }}</div>
        </div>

        <!-- Date fin -->
        <div class="form-group">
          <label>Date fin</label>
          <input type="date" [(ngModel)]="form.endDate" name="endDate" class="underline-input" />
          <div class="error" *ngIf="errors.endDate">{{ errors.endDate }}</div>
        </div>

        <!-- Prix -->
        <div class="form-group full-width">
          <label>Prix</label>
          <div class="input-with-button">
            <input type="number" [(ngModel)]="form.price" name="price" class="underline-input" required min="1" />
            <span class="currency">Fcfa</span>
          </div>
          <div class="error" *ngIf="errors.price">{{ errors.price }}</div>
        </div>
      </div>
    </form>

    <!-- ✅ Mode visualisation -->
    <div *ngIf="!editMode" class="form-card">
      <div class="card-header">
        <h5>Informations de la location</h5>
        <div class="action-buttons">
          <button class="action-btn edit" (click)="enableEdit()" title="Modifier">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn delete" title="Supprimer la location" (click)="showDeleteConfirm = true">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      
      <div class="details-grid">
        <div class="info-card">
          <label>Appartement</label>
          <p>{{ getApartmentName(rental?.apartmentId) }}</p>
        </div>
        <div class="info-card">
          <label>Bâtiment</label>
          <p>{{ getBuildingName(rental?.apartmentId) }}</p>
        </div>
        <div class="info-card">
          <label>Locataire</label>
          <p>{{ getTenantName(rental?.tenantId) }}</p>
        </div>
        <div class="info-card">
          <label>Mensualité</label>
          <p>{{ rental?.price }} Fcfa</p>
        </div>
        <div class="info-card">
          <label>Date de début</label>
          <p>{{ rental?.startDate | date:'dd/MM/yyyy' }}</p>
        </div>
        <div class="info-card">
          <label>Date de fin</label>
          <p>{{ rental?.endDate | date:'dd/MM/yyyy' }}</p>
        </div>
      </div>
    </div>

    <!-- ✅ Contrat + Historique paiements -->
    <div class="contract-history-grid">
      <!-- Contrat -->
      <div class="form-card contract-card">
        <h5>Contrat de location</h5>
        <div class="contract-image-container">
          <img *ngIf="contractImage" [src]="contractImage" alt="Contrat" class="contract-image" />
          <div *ngIf="!contractImage" class="contract-placeholder">
            <i class="fas fa-file-contract"></i>
            <p>Aucun contrat</p>
            <label class="upload-icon-label">
              <i class="fas fa-upload upload-icon" (click)="triggerContractUpload()"></i>
              <input type="file" accept="image/*,.pdf" (change)="onContractSelected($event)" style="display:none;" #contractInput />
            </label>
          </div>
        </div>
        <div class="contract-actions" *ngIf="contractImage">
          <button class="action-btn" title="Télécharger" (click)="downloadContract()">
            <i class="fas fa-download"></i>
          </button>
          <button class="action-btn" title="Voir" (click)="showContractModal = true">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <!-- Modal contrat -->
      <div *ngIf="showContractModal" class="modal-overlay">
        <div class="modal-card contract-modal">
          <div class="modal-header">
            <h5>Contrat de location</h5>
            <button class="close-btn" (click)="showContractModal = false">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <ng-container *ngIf="contractImage && contractImage.startsWith('data:application/pdf')">
              <iframe [src]="contractImage" class="contract-modal-pdf"></iframe>
            </ng-container>
            <ng-container *ngIf="contractImage && !contractImage.startsWith('data:application/pdf')">
              <img [src]="contractImage" alt="Contrat" class="contract-modal-img" />
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Historique paiements -->
      <div class="form-card payment-history">
        <div class="card-header">
          <h5>Historique de paiement</h5>
          <select [(ngModel)]="selectedPeriod" name="selectedPeriod" class="period-filter">
            <option value="">Toutes les périodes</option>
            <option *ngFor="let period of paymentPeriods" [value]="period">{{ period }}</option>
          </select>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Période</th>
                <th>Montant</th>
                <th>Date</th>
                <th>Mode</th>
                <th>Statut</th>
                <th>Recouvreur</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let payment of filteredPayments()">
                <td>{{ payment.period }}</td>
                <td>{{ payment.amount }} Fcfa</td>
                <td>{{ payment.paymentDate | date:'dd/MM/yyyy' }}</td>
                <td>{{ payment.paymentMethod }}</td>
                <td>
                  <span class="status-badge" [ngClass]="{'status-paid': payment.status === 'Payé', 'status-pending': payment.status !== 'Payé'}">
                    {{ payment.status }}
                  </span>
                </td>
                <td>{{ payment.collector }}</td>
              </tr>
              <tr *ngIf="filteredPayments().length === 0">
                <td colspan="6" class="no-data">Aucun paiement enregistré</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>